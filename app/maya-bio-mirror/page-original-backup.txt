/**
 * MAYA BIO-MIRROR - DASHBOARD MAESTRO
 * Integraci√≥n completa: Quantum + InBody + Maya-Vision + Cerebro Maya + Interdrogas
 */

'use client'

import { useState, useRef } from 'react'
import { Brain, Activity, Zap, Heart, TrendingUp, Shield, Camera } from 'lucide-react'
import { cameraAnalyzer } from '@/lib/maya-vision/real-camera-analyzer'
import { SurgeryCalculator } from '@/components/SurgeryCalculator'

// üÜï V3.1: Captura multi-√°ngulo
// import { MultiAngleCapture } from '@/components/MultiAngleCapture'
// import type { MultiAngleCapture as CapturesType } from '@/lib/maya-vision/multi-angle-capture'

// üÜï V3.1: Simulaci√≥n volum√©trica
import { 
  applyVolumetricSimulation, 
  calculateVolumetricChanges 
} from '@/lib/maya-vision/volumetric-simulation'

// üÜï V3.1: Modales
import { SocialShareModal } from '@/components/SocialShareModal'
import { EmailSendModal } from '@/components/EmailSendModal'

// üî• V3.2: MAYA-SCAN 3D (Simple version - sin MediaPipe)
import { MayaScan3DSimple, SimpleMesh3D } from '@/components/MayaScan3DSimple'
// import type { FaceMesh3D } from '@/lib/maya-vision/mesh-3d-generator'

export default function MayaBioMirrorPage() {
  const videoRef = useRef<HTMLVideoElement>(null)
  const fileInputRef = useRef<HTMLInputElement>(null)
  const [patientId, setPatientId] = useState('')
  const [patientName, setPatientName] = useState('')
  const [patientAge, setPatientAge] = useState(35)
  const [cameraActive, setCameraActive] = useState(false)
  const [capturedImage, setCapturedImage] = useState<string | null>(null)
  const [showGuides, setShowGuides] = useState(true)
  const [processing, setProcessing] = useState(false)
  const [result, setResult] = useState<any>(null)
  const [skipInBody, setSkipInBody] = useState(false)
  const [skipQuantum, setSkipQuantum] = useState(false)
  
  // üÜï NUEVOS SELECTORES V3.0
  const [patientGender, setPatientGender] = useState<'M' | 'F'>('F')
  const [patientEthnicity, setPatientEthnicity] = useState<'caucasian' | 'asian' | 'latino' | 'african' | 'middle_eastern'>('latino')
  const [analysisType, setAnalysisType] = useState<'facial' | 'body_breast' | 'body_abdomen' | 'body_gluteal'>('facial')
  const [analysisView, setAnalysisView] = useState<'frontal' | 'lateral' | 'cenital'>('frontal')
  
  // üÜï V3.1: Sistema multi-captura y modales
  const [showMultiCapture, setShowMultiCapture] = useState(false)
  const [capturedImages, setCapturedImages] = useState<any>(null)
  const [showShareModal, setShowShareModal] = useState(false)
  const [showEmailModal, setShowEmailModal] = useState(false)
  
  // üî• V3.2: MAYA-SCAN 3D
  const [show3DScan, setShow3DScan] = useState(false)
  const [mesh3D, setMesh3D] = useState<SimpleMesh3D | null>(null)
  const [scanMode, setScanMode] = useState<'simple' | '3d'>('simple')
  
  const handleStartCamera = async () => {
    if (videoRef.current) {
      const success = await cameraAnalyzer.startCamera(videoRef.current)
      setCameraActive(success)
    }
  }
  
  const handleCapturePhoto = () => {
    const imageData = cameraAnalyzer.capturePhoto()
    if (imageData) {
      setCapturedImage(imageData)
      cameraAnalyzer.stopCamera()
      setCameraActive(false)
    }
  }
  
  const handleRetakePhoto = () => {
    setCapturedImage(null)
    handleStartCamera()
  }
  
  const handleFileUpload = (event: React.ChangeEvent<HTMLInputElement>) => {
    const file = event.target.files?.[0]
    if (file) {
      const reader = new FileReader()
      reader.onload = (e) => {
        const imageData = e.target?.result as string
        setCapturedImage(imageData)
        if (cameraActive) {
          cameraAnalyzer.stopCamera()
          setCameraActive(false)
        }
      }
      reader.readAsDataURL(file)
    }
  }
  
  const handleUploadClick = () => {
    fileInputRef.current?.click()
  }
  
  const handleDownloadPDF = async () => {
    if (!result) return
    
    // Generar Q-Score simulado basado en los datos del paciente
    const { generateQScore } = await import('@/lib/qscore/body-q-engine')
    const { generateQScoreCertificateHTML } = await import('@/lib/qscore/qscore-pdf-certificate')
    
    // Crear Q-Score a partir de los datos disponibles
    const qscore = generateQScore(
      patientId,
      'pre_op',
      {
        facial_satisfaction: [4, 3, 4, 3, 4], // Simulado desde symmetryScore
        facial_distress: [2, 2, 3], // Basado en edad biol√≥gica
        facial_expectations: [4, 4, 3], // Realista por defecto
      },
      {
        nfkb_inflammation: result.inflammation,
        collagen_synthesis: result.collagenSynthesis,
        oxidative_stress: 50
      },
      {
        muscle_mass: result.muscleMass,
        phase_angle: result.phaseAngle,
        body_fat_percentage: result.bodyFat
      }
    )
    
    // Generar certificado Q-Score HTML
    const qscoreCertificate = generateQScoreCertificateHTML(patientName, patientId, qscore)
    
    // Crear contenido HTML para el PDF
    const pdfContent = `
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Pasaporte de Inmortalidad - ${patientName}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 40px; max-width: 900px; margin: 0 auto; }
    h1 { color: #7c3aed; text-align: center; font-size: 36px; margin-bottom: 10px; }
    h2 { color: #6366f1; border-bottom: 3px solid #7c3aed; padding-bottom: 10px; margin-top: 30px; }
    .header { text-align: center; margin-bottom: 40px; border-bottom: 2px solid #7c3aed; padding-bottom: 20px; }
    .metrics { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 30px 0; }
    .metric { background: #f9fafb; padding: 20px; border-radius: 10px; border-left: 4px solid #7c3aed; }
    .metric-title { font-size: 12px; color: #6b7280; text-transform: uppercase; font-weight: bold; }
    .metric-value { font-size: 32px; color: #1f2937; font-weight: bold; margin-top: 5px; }
    .category { background: #f0f9ff; padding: 20px; border-radius: 10px; margin: 20px 0; }
    .category-title { font-size: 20px; font-weight: bold; color: #0369a1; margin-bottom: 15px; }
    .product { margin: 15px 0; padding: 15px; background: white; border-radius: 8px; }
    .product-name { font-weight: bold; color: #1f2937; }
    .product-reason { color: #059669; font-size: 14px; margin-top: 5px; }
    .footer { margin-top: 40px; text-align: center; color: #6b7280; font-size: 12px; border-top: 2px solid #e5e7eb; padding-top: 20px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>üß¨ PASAPORTE DE INMORTALIDAD</h1>
    <p style="font-size: 18px; color: #6b7280;">Sistema Maya Harmony Station</p>
    <p style="font-size: 24px; font-weight: bold; color: #1f2937; margin-top: 10px;">${patientName}</p>
    <p style="color: #6b7280;">ID: ${patientId} | Edad: ${result.chronologicalAge} a√±os | Fecha: ${new Date().toLocaleDateString('es-CO')}</p>
  </div>
  
  <h2>üìä EDAD BIOL√ìGICA</h2>
  <div class="metrics">
    <div class="metric">
      <div class="metric-title">Edad Cronol√≥gica</div>
      <div class="metric-value">${result.chronologicalAge} a√±os</div>
    </div>
    <div class="metric">
      <div class="metric-title">Edad Biol√≥gica</div>
      <div class="metric-value" style="color: #10b981;">${result.biologicalAge} a√±os</div>
    </div>
  </div>
  <div style="background: #d1fae5; padding: 15px; border-radius: 10px; text-align: center; font-size: 20px; font-weight: bold; color: #065f46;">
    ‚úÖ ERES ${result.chronologicalAge - result.biologicalAge} A√ëOS M√ÅS JOVEN que tu edad cronol√≥gica
  </div>
  
  <h2>üéØ M√âTRICAS BIOL√ìGICAS</h2>
  <div class="metrics">
    <div class="metric">
      <div class="metric-title">Simetr√≠a (Golden Ratio)</div>
      <div class="metric-value">${result.symmetryScore}/100</div>
    </div>
    <div class="metric">
      <div class="metric-title">Calidad Piel (Obagi)</div>
      <div class="metric-value">${result.skinQuality}/100</div>
    </div>
    <div class="metric">
      <div class="metric-title">Laxitud Facial</div>
      <div class="metric-value">${result.laxityScore}/100</div>
    </div>
    <div class="metric">
      <div class="metric-title">√Ångulo de Fase</div>
      <div class="metric-value">${result.phaseAngle}¬∞</div>
    </div>
    <div class="metric">
      <div class="metric-title">Masa Muscular</div>
      <div class="metric-value">${result.muscleMass}kg</div>
    </div>
    <div class="metric">
      <div class="metric-title">Col√°geno</div>
      <div class="metric-value">${result.collagenSynthesis}/100</div>
    </div>
  </div>
  
  <h2>üíä PLAN DE PRODUCTOS PERSONALIZADO</h2>
  
  <div class="category" style="background: #faf5ff;">
    <div class="category-title" style="color: #7c3aed;">üß¥ DERMATOL√ìGICOS (Uso T√≥pico)</div>
    <div class="product">
      <div class="product-name">Retinol 0.1% (Obagi Protocol)</div>
      <div class="product-reason">‚Üí Calidad de piel ${result.skinQuality}/100 - estimulaci√≥n de col√°geno d√©rmico</div>
    </div>
    <div class="product">
      <div class="product-name">Hidroquinona 4% + Vitamina C</div>
      <div class="product-reason">‚Üí Protecci√≥n antioxidante y uniformidad del tono</div>
    </div>
  </div>
  
  <div class="category" style="background: #f0fdf4;">
    <div class="category-title" style="color: #059669;">üíä NUTRACEUTICOS (Suplementos Orales)</div>
    <div class="product">
      <div class="product-name">Col√°geno Hidrolizado Tipo I + III (10g/d√≠a)</div>
      <div class="product-reason">‚Üí S√≠ntesis col√°geno ${result.collagenSynthesis}/100 - soporte estructural</div>
    </div>
    <div class="product">
      <div class="product-name">L-Leucina + BCAA (5g + 10g - 2x/d√≠a)</div>
      <div class="product-reason">‚Üí Masa muscular ${result.muscleMass}kg - activaci√≥n mTOR pathway</div>
    </div>
    <div class="product">
      <div class="product-name">Omega-3 EPA/DHA (2g/d√≠a)</div>
      <div class="product-reason">‚Üí Inflamaci√≥n ${result.inflammation}/100 - modulaci√≥n NFŒ∫B</div>
    </div>
    <div class="product">
      <div class="product-name">NAD+ Precursor (NMN 250mg)</div>
      <div class="product-reason">‚Üí Edad biol√≥gica ${result.biologicalAge} a√±os - reprogramaci√≥n epigen√©tica</div>
    </div>
  </div>
  
  <div class="category" style="background: #fef2f2;">
    <div class="category-title" style="color: #dc2626;">‚úÇÔ∏è PROCEDIMIENTOS QUIR√öRGICOS</div>
    <div class="product">
      <div class="product-name">Deep Plane SMAS Facelift (Connell)</div>
      <div class="product-reason">‚Üí Laxitud facial ${result.laxityScore}/100 - reposicionamiento vectorial</div>
    </div>
    <div class="product">
      <div class="product-name">Rinoplastia Estructural (Golden Ratio 1.618)</div>
      <div class="product-reason">‚Üí Simetr√≠a ${result.symmetryScore}/100 - optimizaci√≥n facial</div>
    </div>
  </div>
  
  <div style="background: linear-gradient(to right, #7c3aed, #ec4899); color: white; padding: 30px; border-radius: 15px; text-align: center; margin: 30px 0;">
    <div style="font-size: 14px; font-weight: bold; text-transform: uppercase; opacity: 0.9;">Inversi√≥n Mensual</div>
    <div style="font-size: 48px; font-weight: bold; margin: 10px 0;">$${(result.monthlyCost / 1000).toFixed(0)}K COP</div>
    <div style="font-size: 14px; opacity: 0.9;">(Solo productos recurrentes - excluye cirug√≠as)</div>
  </div>
  
  <h2>üìê RATIOS CIENT√çFICOS APLICADOS</h2>
  <ul style="line-height: 2; color: #374151;">
    <li><strong>Le Fort I:</strong> Ajuste de tercio medio facial seg√∫n estructura √≥sea</li>
    <li><strong>Ratio Sagital:</strong> Correcci√≥n de proyecci√≥n nasal y ment√≥n</li>
    <li><strong>Deep Plane SMAS:</strong> Reposicionamiento vectorial de tejidos profundos</li>
    <li><strong>Col√°geno: ${result.collagenSynthesis}/100</strong> - Capacidad de cicatrizaci√≥n √≥ptima</li>
    <li><strong>Grasa Visceral: ${result.visceralFat}/20</strong> - Inflamaci√≥n bajo control</li>
  </ul>
  
  <div class="footer">
    <p><strong>Maya Harmony Station</strong> - Sistema Integrado de Bioingenier√≠a Humana</p>
    <p>Este documento fue generado autom√°ticamente mediante s√≠ntesis de 50+ tratados m√©dicos</p>
    <p>Bases cient√≠ficas: Byung Pal Yu (Epigen√©tica), Bruce Connell (Facial), Zein Obagi (Piel), Rei Ogawa (Cicatrizaci√≥n)</p>
    <p style="margin-top: 20px;">üì± Interdrogas WhatsApp: 6024873000</p>
  </div>
</body>
</html>

${qscoreCertificate}

    `
    
    // Crear blob y descargar
    const blob = new Blob([pdfContent], { type: 'text/html' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `Pasaporte_Inmortalidad_${patientName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.html`
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
    
    alert('‚úÖ Pasaporte de Inmortalidad descargado! √Åbrelo en tu navegador e impr√≠melo como PDF.')
  }
  
  // üÜï V3.0: FUNCI√ìN PARA ENVIAR POR EMAIL
  const handleSendEmail = () => {
    if (!result || !patientName) {
      alert('‚ö†Ô∏è Genera el diagn√≥stico primero')
      return
    }
    
    const subject = encodeURIComponent(`Pasaporte de Inmortalidad - ${patientName}`)
    const body = encodeURIComponent(`Hola ${patientName},\n\nAdjunto encontrar√°s tu Pasaporte de Inmortalidad generado por Maya Harmony Station.\n\nüìä Resumen:\n- Edad Biol√≥gica: ${result.biologicalAge} a√±os (cronol√≥gica: ${result.chronologicalAge})\n- Simetr√≠a: ${result.symmetryScore}/100\n- Calidad de Piel: ${result.skinQuality}/100\n- Laxitud: ${result.laxityScore}/100\n\nPor favor descarga el PDF completo desde la aplicaci√≥n para ver tu plan de tratamiento personalizado.\n\nSaludos,\nDr. Maya`)
    
    // Abrir cliente de email
    window.location.href = `mailto:?subject=${subject}&body=${body}`
    alert('‚úÖ Se abri√≥ tu cliente de email. Adjunta el PDF descargado.')
  }
  
  // üÜï V3.0: FUNCI√ìN PARA COMPARTIR
  const handleShare = async () => {
    if (!result || !patientName) {
      alert('‚ö†Ô∏è Genera el diagn√≥stico primero')
      return
    }
    
    const shareData = {
      title: `Pasaporte de Inmortalidad - ${patientName}`,
      text: `Mi an√°lisis biol√≥gico Maya Harmony:\n\n‚ú® Edad Biol√≥gica: ${result.biologicalAge} a√±os\nüíé Simetr√≠a: ${result.symmetryScore}/100\nüß¨ Sistema: Maya Harmony Station`,
      url: window.location.href
    }
    
    // Verificar si el navegador soporta Web Share API
    if (navigator.share) {
      try {
        await navigator.share(shareData)
        alert('‚úÖ Compartido exitosamente')
      } catch (err: any) {
        if (err.name !== 'AbortError') {
          console.error('Error al compartir:', err)
          fallbackShare(shareData)
        }
      }
    } else {
      fallbackShare(shareData)
    }
  }
  
  // Funci√≥n fallback para navegadores sin Web Share API
  const fallbackShare = (data: any) => {
    const text = `${data.title}\n\n${data.text}\n\n${data.url}`
    
    // Copiar al portapapeles
    navigator.clipboard.writeText(text).then(() => {
      alert('‚úÖ Texto copiado al portapapeles. P√©galo donde quieras compartirlo.')
    }).catch(() => {
      alert('üì± Comparte manualmente:\n\n' + text)
    })
  }
  
  const handleCompleteDiagnosis = async () => {
    console.log('üé¨ handleCompleteDiagnosis llamado')
    
    if (!patientId || !patientName) {
      alert('Por favor ingresa ID y nombre del paciente')
      return
    }
    
    if (!capturedImage && !mesh3D) {
      alert('Por favor toma una foto o realiza un escaneo 3D primero')
      return
    }
    
    console.log('‚úÖ Validaciones pasadas, iniciando procesamiento...')
    console.log('üß¨ Modo de escaneo:', mesh3D ? '3D (MediaPipe)' : 'Simple (2D)')
    setProcessing(true)
    
    try {
      console.log('üöÄ Iniciando diagn√≥stico completo...')
      console.log('   - Paciente ID:', patientId)
      console.log('   - Nombre:', patientName)
      console.log('   - Edad:', patientAge)
      console.log('   - Foto capturada:', capturedImage ? 'S√≠' : 'No')
      console.log('   - Malla 3D:', mesh3D ? 'S√≠ ‚ú®' : 'No')
      
      // PASO 1: An√°lisis Maya-Vision (2D o 3D seg√∫n modo)
      let mayaVisionResult: any
      
      if (mesh3D) {
        // üî• MODO 3D: Usar datos reales de MediaPipe
        console.log('üß¨ PASO 1: Usando an√°lisis 3D de MediaPipe...')
        mayaVisionResult = {
          connell_analysis: {
            facial_laxity_score: 100 - (mesh3D.nasolabialFoldDepth * 5),
            jowls_severity: Math.min(10, mesh3D.nasolabialFoldDepth / 2),
            nasolabial_folds: Math.min(10, mesh3D.nasolabialFoldDepth),
            marionette_lines: Math.min(10, mesh3D.jawlineDepthMap.reduce((a, b) => a + b, 0) / mesh3D.jawlineDepthMap.length),
            neck_bands: mesh3D.cervicoMentalAngle < 105,
            recommended_technique: mesh3D.nasolabialFoldDepth > 3 ? 'Deep Plane SMAS' : 'SMAS'
          },
          obagi_analysis: {
            skin_quality_score: Math.max(50, 100 - mesh3D.infraorbitalHollowVolume),
            texture: mesh3D.infraorbitalHollowVolume > 50 ? 'rough' : 'smooth',
            hydration: Math.max(30, 100 - mesh3D.infraorbitalHollowVolume / 2),
            pigmentation: 3,
            elasticity: 100 - (mesh3D.nasolabialFoldDepth * 4),
            recommended_protocol: 'Retinol Protocol'
          },
          symmetry_analysis: {
            golden_ratio_score: mesh3D.goldenRatioScore,
            left_right_balance: mesh3D.leftRightSymmetry,
            upper_lower_balance: mesh3D.upperLowerSymmetry
          },
          measurements_3d: mesh3D // üî• INCLUIR TODAS LAS MEDICIONES 3D
        }
        console.log('‚úÖ An√°lisis 3D completado con mediciones reales')
      } else {
        // Modo 2D tradicional
        console.log('üì∏ PASO 1: Analizando foto con Maya-Vision...')
        mayaVisionResult = await cameraAnalyzer.analyzePhoto(capturedImage, patientAge)
        console.log('‚úÖ Maya-Vision completado:', mayaVisionResult)
      }
      
      await new Promise(resolve => setTimeout(resolve, 1000))
      
      // PASO 2: InBody H30 (opcional)
      let inBodyData = null
      if (!skipInBody) {
        console.log('üí™ PASO 2: Leyendo datos InBody H30...')
        try {
          const { inBodyConnector } = await import('@/lib/hardware/real-inbody-connector')
          await inBodyConnector.connect()
          inBodyData = await inBodyConnector.readData()
          console.log('‚úÖ InBody datos recibidos:', inBodyData)
          await new Promise(resolve => setTimeout(resolve, 1000))
        } catch (error) {
          console.warn('‚ö†Ô∏è InBody no disponible, usando datos simulados:', error)
          inBodyData = null
        }
      } else {
        console.log('‚è≠Ô∏è InBody omitido por usuario')
      }
      
      // PASO 3: Quantum Analyzer (opcional)
      let quantumData = null
      if (!skipQuantum) {
        console.log('‚öõÔ∏è PASO 3: Realizando escaneo cu√°ntico...')
        try {
          const { quantumConnector } = await import('@/lib/hardware/real-quantum-connector')
          await quantumConnector.connect()
          quantumData = await quantumConnector.readData(patientAge)
          console.log('‚úÖ Quantum datos recibidos:', quantumData)
          await new Promise(resolve => setTimeout(resolve, 1000))
        } catch (error) {
          console.warn('‚ö†Ô∏è Quantum Analyzer no disponible, usando datos simulados:', error)
          quantumData = null
        }
      } else {
        console.log('‚è≠Ô∏è Quantum Analyzer omitido por usuario')
      }
      
      // PASO 4: Calcular edad biol√≥gica
      const biologicalAge = quantumData?.biological_age || Math.max(patientAge - 5, 25)
      
      // PASO 4.5: Generar visualizaciones tipo Canfield VISIA
      console.log('üé® Generando visualizaciones tipo VISIA...')
      const { imageProcessor } = await import('@/lib/maya-vision/image-processor')
      
      // üÜï V3.1: Calcular cambios volum√©tricos necesarios
      const volumetricChanges = calculateVolumetricChanges({
        age: patientAge,
        laxityScore: mayaVisionResult.connell_analysis.facial_laxity_score,
        skinQuality: mayaVisionResult.obagi_analysis.skin_quality_score,
        gender: patientGender
      })
      console.log('üìä Cambios volum√©tricos calculados:', volumetricChanges)
      
      const visuals = await imageProcessor.generateVisualAnalysis(
        capturedImages?.frontal || capturedImage,  // Usar foto frontal si hay multi-captura
        {
          laxityScore: mayaVisionResult.connell_analysis.facial_laxity_score,
          skinQuality: mayaVisionResult.obagi_analysis.skin_quality_score,
          symmetryScore: mayaVisionResult.symmetry_analysis.golden_ratio_score,
          age: patientAge
        }
      )
      console.log('‚úÖ Visualizaciones est√°ndar generadas')
      
      // üÜï V3.1: Aplicar simulaci√≥n volum√©trica REAL
      console.log('üé® Aplicando simulaci√≥n volum√©trica (surcos, ojeras, mand√≠bula)...')
      try {
        const volumetricSimulation = await applyVolumetricSimulation(
          capturedImages?.frontal || capturedImage,
          volumetricChanges
        )
        visuals.afterSimulation = volumetricSimulation
        console.log('‚úÖ Simulaci√≥n volum√©trica aplicada exitosamente')
      } catch (error) {
        console.error('‚ö†Ô∏è Error en simulaci√≥n volum√©trica, usando est√°ndar:', error)
      }
      
      // PASO 5: Compilar resultado
      const result = {
        // Edad biol√≥gica
        biologicalAge: biologicalAge,
        chronologicalAge: patientAge,
        
        // Maya-Vision
        symmetryScore: mayaVisionResult.symmetry_analysis.golden_ratio_score,
        skinQuality: mayaVisionResult.obagi_analysis.skin_quality_score,
        laxityScore: mayaVisionResult.connell_analysis.facial_laxity_score,
        
        // InBody
        muscleMass: inBodyData?.muscle_mass || 32.5,
        bodyFat: inBodyData?.body_fat_percentage || 22.5,
        phaseAngle: inBodyData?.phase_angle || 6.1,
        visceralFat: inBodyData?.visceral_fat_level || 8,
        
        // Quantum
        collagenSynthesis: quantumData?.collagen_synthesis || 68,
        inflammation: quantumData?.nfkb_inflammation || 45,
        oxidativeStress: quantumData?.oxidative_stress || 50,
        
        // Prescripci√≥n (calculado)
        prescriptionItems: 8,
        monthlyCost: 480000,
        passportReady: true,
        
        // Fotos y visualizaciones
        photoData: capturedImage,
        visuals: visuals // ‚ú® NUEVO: 6 visualizaciones tipo Canfield
      }
      
      // PASO 6: Generar recomendaciones personalizadas (Park + Connell + Obagi + Yu)
      console.log('üß† Generando recomendaciones personalizadas con motor integrado...')
      const { recommendationsEngine } = await import('@/lib/recommendations/integrated-recommendations')
      
      // Preparar an√°lisis 3D para el motor
      const analysis3D = {
        frontal: {
          bigonial_width: patientGender === 'F' ? 90 + (Math.random() * 20 - 10) : 100 + (Math.random() * 20 - 10),  // Simulado
          bizygomatic_width: patientGender === 'F' ? 120 + (Math.random() * 15 - 7) : 130 + (Math.random() * 15 - 7),
          symmetry: result.symmetryScore,
          laxity: result.laxityScore,
          skin_quality: result.skinQuality
        },
        lateral: {
          nasolabial_angle: 90 + (Math.random() * 20),  // 90-110¬∞ normal
          chin_projection: (Math.random() * 10) - 5,  // -5 a +5mm
          cervicomental_angle: 105 + (Math.random() * 15)  // 105-120¬∞ normal
        },
        cenital: {
          mandibular_contour: result.laxityScore > 40 ? 'square' : 'oval',
          malar_projection: 8 + (Math.random() * 6)  // 8-14mm
        }
      }
      
      const treatmentPlan = recommendationsEngine.generateCompletePlan(
        {
          age: patientAge,
          gender: patientGender,
          ethnicity: patientEthnicity,
          analysisType: analysisType,
          view: analysisView
        },
        analysis3D as any
      )
      
      console.log('‚úÖ Plan de tratamiento generado:', treatmentPlan)
      
      // Agregar al resultado
      result.treatmentPlan = treatmentPlan
      result.analysis3D = analysis3D
      
      console.log('‚úÖ Diagn√≥stico completado')
      console.log('üìä Edad biol√≥gica:', biologicalAge, 'a√±os')
      console.log('üìä Simetr√≠a:', result.symmetryScore)
      console.log('üìä Calidad piel:', result.skinQuality)
      console.log('üìä Resultado final:', result)
      
      console.log('üéØ Actualizando estado con resultado...')
      setResult(result)
      console.log('‚úÖ Estado actualizado, diagn√≥stico terminado')
      
      // Scroll suave a los resultados
      setTimeout(() => {
        window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' })
      }, 500)
      
    } catch (error: any) {
      console.error('‚ùå ERROR CR√çTICO en handleCompleteDiagnosis:')
      console.error('   Tipo:', error?.constructor?.name)
      console.error('   Mensaje:', error?.message)
      console.error('   Stack:', error?.stack)
      console.error('   Objeto completo:', error)
      
      alert(`‚ùå Error en el diagn√≥stico:\n\n${error?.message || error}\n\nRevisa la consola del navegador (F12) para m√°s detalles.`)
    } finally {
      console.log('üèÅ Finalizando procesamiento...')
      setProcessing(false)
      console.log('üèÅ Processing = false')
    }
  }
  
  return (
    <div className="min-h-screen bg-gradient-to-br from-indigo-50 via-white to-purple-50">
      {/* HEADER LUXURY */}
      <div className="bg-gradient-to-r from-purple-900 via-indigo-900 to-purple-900 text-white py-20">
        <div className="container mx-auto px-4 text-center">
          <div className="inline-block mb-6">
            <div className="w-32 h-32 bg-white/20 backdrop-blur-xl rounded-full flex items-center justify-center border-4 border-white/30 mx-auto">
              <Brain className="w-16 h-16" />
            </div>
          </div>
          <h1 className="text-6xl font-black mb-4 tracking-tight">
            MAYA BIO-MIRROR
          </h1>
          <p className="text-2xl font-light opacity-90">
            Sistema Integrado de Bioingenier√≠a Humana
          </p>
          <div className="mt-8 flex justify-center gap-8 text-sm">
            <div className="flex items-center gap-2">
              <Activity className="w-5 h-5" />
              <span>InBody H30</span>
            </div>
            <div className="flex items-center gap-2">
              <Zap className="w-5 h-5" />
              <span>Quantum Analyzer</span>
            </div>
            <div className="flex items-center gap-2">
              <Brain className="w-5 h-5" />
              <span>50+ Tratados M√©dicos</span>
            </div>
          </div>
        </div>
      </div>
      
      {/* MAIN CONTENT */}
      <div className="container mx-auto px-4 py-12">
        {/* INPUT SECTION */}
        <div className="max-w-4xl mx-auto mb-12">
          <div className="bg-white rounded-3xl shadow-2xl p-10">
            <h2 className="text-3xl font-bold text-gray-900 mb-8">
              üî¨ Iniciar Diagn√≥stico Completo
            </h2>
            
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  ID del Paciente *
                </label>
                <input
                  type="text"
                  value={patientId}
                  onChange={(e) => setPatientId(e.target.value)}
                  placeholder="UUID o c√≥digo"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-500/20 focus:border-purple-500 transition-all"
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  Nombre Completo *
                </label>
                <input
                  type="text"
                  value={patientName}
                  onChange={(e) => setPatientName(e.target.value)}
                  placeholder="Juan P√©rez"
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-500/20 focus:border-purple-500 transition-all"
                />
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  Edad
                </label>
                <input
                  type="number"
                  value={patientAge}
                  onChange={(e) => setPatientAge(parseInt(e.target.value) || 0)}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-500/20 focus:border-purple-500 transition-all"
                />
              </div>
              
              {/* üÜï V3.0: SELECTORES PERSONALIZADOS */}
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  G√©nero
                </label>
                <select
                  value={patientGender}
                  onChange={(e) => setPatientGender(e.target.value as 'M' | 'F')}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-500/20 focus:border-purple-500 transition-all"
                >
                  <option value="F">üë© Femenino</option>
                  <option value="M">üë® Masculino</option>
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  Etnia
                </label>
                <select
                  value={patientEthnicity}
                  onChange={(e) => setPatientEthnicity(e.target.value as any)}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-500/20 focus:border-purple-500 transition-all"
                >
                  <option value="latino">üåé Latino/Hispano</option>
                  <option value="caucasian">üá™üá∫ Cauc√°sico</option>
                  <option value="asian">üáØüáµ Asi√°tico (Este/Sudeste)</option>
                  <option value="african">üåç Africano/Afrodescendiente</option>
                  <option value="middle_eastern">üá∏üá¶ Medio Oriente</option>
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  Tipo de An√°lisis
                </label>
                <select
                  value={analysisType}
                  onChange={(e) => setAnalysisType(e.target.value as any)}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-500/20 focus:border-purple-500 transition-all"
                >
                  <option value="facial">üë§ Facial (rostro completo)</option>
                  <option value="body_breast">üíé Corporal - Senos</option>
                  <option value="body_abdomen">üèãÔ∏è Corporal - Abdomen</option>
                  <option value="body_gluteal">üçë Corporal - Gl√∫teo</option>
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-3">
                  Vista / √Ångulo
                </label>
                <select
                  value={analysisView}
                  onChange={(e) => setAnalysisView(e.target.value as any)}
                  className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-4 focus:ring-purple-500/20 focus:border-purple-500 transition-all"
                >
                  <option value="frontal">üì∏ Frontal</option>
                  <option value="lateral">üëà Lateral (perfil)</option>
                  <option value="cenital">üîù Cenital (desde arriba)</option>
                </select>
              </div>
            </div>
            
            {/* OPCIONES DE EQUIPOS */}
            <div className="mb-8 bg-amber-50 border-2 border-amber-200 rounded-xl p-6">
              <h3 className="text-lg font-bold text-amber-900 mb-4">
                ‚öôÔ∏è Equipos Opcionales
              </h3>
              <p className="text-sm text-amber-700 mb-4">
                Si no tienes los equipos disponibles, puedes omitirlos. El an√°lisis usar√° datos basados en la foto y edad.
              </p>
              <div className="space-y-3">
                <label className="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={skipInBody}
                    onChange={(e) => setSkipInBody(e.target.checked)}
                    className="w-5 h-5 rounded border-2 border-amber-400 text-amber-600 focus:ring-amber-500"
                  />
                  <span className="text-sm font-medium text-gray-700">
                    Omitir InBody H30 (an√°lisis de composici√≥n corporal)
                  </span>
                </label>
                <label className="flex items-center gap-3 cursor-pointer">
                  <input
                    type="checkbox"
                    checked={skipQuantum}
                    onChange={(e) => setSkipQuantum(e.target.checked)}
                    className="w-5 h-5 rounded border-2 border-amber-400 text-amber-600 focus:ring-amber-500"
                  />
                  <span className="text-sm font-medium text-gray-700">
                    Omitir Quantum Analyzer (escaneo biocu√°ntico)
                  </span>
                </label>
              </div>
            </div>
            
            {/* üÜï V3.1: SECCI√ìN DE FOTO MULTI-√ÅNGULO */}
            <div className="mb-8">
              <h3 className="text-xl font-bold text-gray-900 mb-4 flex items-center gap-2">
                <span>üì∏ Captura Multi-√Ångulo (4 Fotos)</span>
                <span className="text-sm font-normal text-purple-600 bg-purple-100 px-3 py-1 rounded-full">
                  üÜï V3.1
                </span>
              </h3>
              <p className="text-sm text-gray-600 mb-4">
                Sistema guiado paso a paso: Frontal + Perfil Derecho + Perfil Izquierdo + Cenital
              </p>
              
              {/* üÜï V3.1: Preview de capturas multi-√°ngulo */}
              {capturedImages && (
                <div className="grid grid-cols-2 gap-4 mb-4">
                  <div className="border-2 border-green-400 rounded-xl overflow-hidden">
                    <div className="bg-green-100 text-green-800 text-xs font-bold text-center py-1">
                      ‚úì Frontal
                    </div>
                    <img src={capturedImages.frontal!} alt="Frontal" className="w-full aspect-[4/3] object-cover" />
                  </div>
                  <div className="border-2 border-green-400 rounded-xl overflow-hidden">
                    <div className="bg-green-100 text-green-800 text-xs font-bold text-center py-1">
                      ‚úì Lateral Derecho
                    </div>
                    <img src={capturedImages.lateral_right!} alt="Lateral D" className="w-full aspect-[4/3] object-cover" />
                  </div>
                  <div className="border-2 border-green-400 rounded-xl overflow-hidden">
                    <div className="bg-green-100 text-green-800 text-xs font-bold text-center py-1">
                      ‚úì Lateral Izquierdo
                    </div>
                    <img src={capturedImages.lateral_left!} alt="Lateral I" className="w-full aspect-[4/3] object-cover" />
                  </div>
                  <div className="border-2 border-green-400 rounded-xl overflow-hidden">
                    <div className="bg-green-100 text-green-800 text-xs font-bold text-center py-1">
                      ‚úì Cenital
                    </div>
                    <img src={capturedImages.cenital!} alt="Cenital" className="w-full aspect-[4/3] object-cover" />
                  </div>
                </div>
              )}
              
              {/* Placeholder si no hay capturas */}
              {!capturedImages && (
                <div className="relative aspect-[4/3] bg-gradient-to-br from-purple-900 to-indigo-900 rounded-2xl overflow-hidden mb-4 flex items-center justify-center">
                  <div className="text-center text-white">
                    <Camera className="w-24 h-24 mx-auto mb-6 opacity-30" />
                    <h4 className="text-2xl font-bold mb-3">Captura 4 √Ångulos</h4>
                    <p className="text-lg opacity-90 mb-2">Sistema guiado paso a paso</p>
                    <p className="text-sm opacity-70">
                      Frontal ‚Üí Lateral D ‚Üí Lateral I ‚Üí Cenital
                    </p>
                  </div>
                </div>
              )}
              
              {/* C√ÅMARA Y CAPTURA */}
              <div className="relative bg-black rounded-2xl overflow-hidden" style={{ minHeight: '400px' }}>
                {!capturedImage ? (
                  <>
                    {cameraActive ? (
                      <>
                        <video
                          ref={videoRef}
                          autoPlay
                          playsInline
                          muted
                          className="w-full h-auto"
                        />
                        {showGuides && (
                          <div className="absolute inset-0 pointer-events-none">
                            <div className="absolute left-1/2 top-0 bottom-0 w-0.5 bg-green-400/50 transform -translate-x-1/2"></div>
                            <div className="absolute left-0 right-0 top-1/3 h-0.5 bg-green-400/50"></div>
                            <div className="absolute left-0 right-0 top-2/3 h-0.5 bg-green-400/50"></div>
                            <div className="absolute inset-0 flex items-center justify-center">
                              <div className="w-64 h-80 border-2 border-green-400/60 rounded-full"></div>
                            </div>
                            <div className="absolute top-4 left-1/2 transform -translate-x-1/2 bg-black/70 backdrop-blur-sm px-6 py-3 rounded-full">
                              <p className="text-white text-sm font-medium text-center">
                                Alinea tu rostro con el √≥valo ‚Ä¢ L√≠nea vertical en el centro de la cara
                              </p>
                            </div>
                          </div>
                        )}
                      </>
                    ) : (
                      <div className="flex items-center justify-center h-96 bg-gray-900">
                        <p className="text-white text-lg">C√°mara no activa</p>
                      </div>
                    )}
                  </>
                ) : (
                  <img src={capturedImage} alt="Captured" className="w-full h-auto" />
                )}
              </div>
              
              {/* üî• SELECTOR DE MODO DE CAPTURA */}
              {!capturedImage && !mesh3D && (
                <div className="mb-4 bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 border-2 border-indigo-200">
                  <p className="text-sm font-semibold text-gray-700 mb-3">Modo de Captura:</p>
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      onClick={() => setScanMode('simple')}
                      className={`py-3 px-4 rounded-lg font-bold transition-all ${
                        scanMode === 'simple'
                          ? 'bg-gradient-to-r from-blue-500 to-indigo-600 text-white shadow-lg'
                          : 'bg-white text-gray-700 hover:bg-gray-50'
                      }`}
                    >
                      üì∏ Foto Simple
                    </button>
                    <button
                      onClick={() => setScanMode('3d')}
                      className={`py-3 px-4 rounded-lg font-bold transition-all ${
                        scanMode === '3d'
                          ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white shadow-lg'
                          : 'bg-white text-gray-700 hover:bg-gray-50'
                      }`}
                    >
                      üß¨ Escaneo 3D
                    </button>
                  </div>
                </div>
              )}
              
              {/* BOTONES DE ACCI√ìN */}
              <div className="grid grid-cols-2 gap-4">
                {!capturedImage && !mesh3D ? (
                  <>
                    {scanMode === '3d' ? (
                      <button
                        onClick={() => setShow3DScan(true)}
                        className="col-span-2 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-8 rounded-xl font-black text-2xl transition-all flex items-center justify-center gap-3 shadow-2xl hover:shadow-green-500/50 animate-pulse"
                      >
                        üß¨ INICIAR ESCANEO 3D
                        <span className="text-sm font-normal ml-2 bg-white/20 px-3 py-1 rounded-full">NUEVO</span>
                      </button>
                    ) : !cameraActive ? (
                      <button
                        onClick={handleStartCamera}
                        className="col-span-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white py-6 rounded-xl font-bold text-xl transition-all flex items-center justify-center gap-3 shadow-lg hover:shadow-xl"
                      >
                        <Camera className="w-7 h-7" />
                        üì∏ INICIAR C√ÅMARA
                      </button>
                    ) : (
                      <>
                        <button
                          onClick={handleCapturePhoto}
                          className="bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white py-6 rounded-xl font-bold text-xl transition-all flex items-center justify-center gap-3 shadow-lg"
                        >
                          <Camera className="w-6 h-6" />
                          üì∏ CAPTURAR
                        </button>
                        <button
                          onClick={handleUploadClick}
                          className="bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white py-6 rounded-xl font-bold text-xl transition-all flex items-center justify-center gap-3"
                        >
                          üìÅ SUBIR ARCHIVO
                        </button>
                        <input
                          ref={fileInputRef}
                          type="file"
                          accept="image/*"
                          onChange={handleFileUpload}
                          className="hidden"
                        />
                      </>
                    )}
                  </>
                ) : (
                  <button
                    onClick={handleRetakePhoto}
                    className="col-span-2 bg-gray-500 hover:bg-gray-600 text-white py-4 rounded-xl font-bold transition-all flex items-center justify-center gap-2"
                  >
                    <Camera className="w-5 h-5" />
                    üîÑ Retomar Foto
                  </button>
                )}
              </div>
              
              {/* üÜï V3.1: Modal de captura multi-√°ngulo */}
              {/* TEMPORALMENTE DESACTIVADO - DEBUGGEANDO
              {showMultiCapture && (
                <MultiAngleCapture
                  onComplete={(captures) => {
                    setCapturedImages(captures)
                    // Tambi√©n guardar la foto frontal como capturedImage para compatibilidad
                    setCapturedImage(captures.frontal)
                    setShowMultiCapture(false)
                  }}
                  onCancel={() => setShowMultiCapture(false)}
                />
              )}
              */}
              
              {/*OLD CODE TO DELETE - START*/}
              {false && cameraActive && showGuides && (
                      <div className="absolute inset-0 pointer-events-none">
                        {/* L√≠nea vertical central */}
                        <div className="absolute left-1/2 top-0 bottom-0 w-0.5 bg-green-400/50 transform -translate-x-1/2"></div>
                        
                        {/* L√≠neas horizontales para tercios faciales */}
                        <div className="absolute left-0 right-0 top-1/3 h-0.5 bg-green-400/50"></div>
                        <div className="absolute left-0 right-0 top-2/3 h-0.5 bg-green-400/50"></div>
                        
                        {/* √ìvalo gu√≠a para rostro */}
                        <div className="absolute inset-0 flex items-center justify-center">
                          <div className="w-64 h-80 border-2 border-green-400/60 rounded-full"></div>
                        </div>
                        
                        {/* Instrucciones overlay */}
                        <div className="absolute top-4 left-1/2 transform -translate-x-1/2 bg-black/70 backdrop-blur-sm px-6 py-3 rounded-full">
                          <p className="text-white text-sm font-medium text-center">
                            Alinea tu rostro con el √≥valo ‚Ä¢ L√≠nea vertical en el centro de la cara
                          </p>
                        </div>
                        
                        {/* Indicadores de posici√≥n */}
                        <div className="absolute top-1/3 left-4 bg-black/70 backdrop-blur-sm px-3 py-1 rounded text-xs text-white">
                          Superior: L√≠nea del cabello
                        </div>
                        <div className="absolute top-1/2 left-4 bg-black/70 backdrop-blur-sm px-3 py-1 rounded text-xs text-white">
                          Medio: Ojos y nariz
                        </div>
                        <div className="absolute top-2/3 left-4 bg-black/70 backdrop-blur-sm px-3 py-1 rounded text-xs text-white">
                          Inferior: Boca y ment√≥n
                        </div>
                        
                        {/* Grid fino (opcional) */}
                        <div className="absolute inset-0 opacity-20">
                          <div className="grid grid-cols-3 grid-rows-3 h-full">
                            {[...Array(9)].map((_, i) => (
                              <div key={i} className="border border-green-400/30"></div>
                            ))}
                          </div>
                        </div>
                        
                        {/* Indicador de calidad */}
                        <div className="absolute bottom-4 left-4 right-4 flex justify-between items-center">
                          <div className="bg-black/70 backdrop-blur-sm px-4 py-2 rounded-lg">
                            <div className="flex items-center gap-2 text-white text-sm">
                              <div className="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
                              <span>Buena iluminaci√≥n</span>
                            </div>
                          </div>
                          <div className="bg-black/70 backdrop-blur-sm px-4 py-2 rounded-lg">
                            <div className="flex items-center gap-2 text-white text-sm">
                              <span>Distancia: Correcta ‚úì</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {!cameraActive && (
                      <div className="absolute inset-0 flex items-center justify-center bg-gray-900/80">
                        <div className="text-center text-white">
                          <Camera className="w-16 h-16 mx-auto mb-4 opacity-50" />
                          <p className="text-lg mb-2">Captura tu foto</p>
                          <p className="text-sm opacity-70">Usa la c√°mara o sube una imagen</p>
                        </div>
                      </div>
                    )}
                    
                    {cameraActive && (
                      <div className="absolute top-4 right-4 bg-red-500 text-white px-3 py-1 rounded-full text-sm flex items-center gap-2">
                        <span className="w-2 h-2 bg-white rounded-full animate-pulse"></span>
                        EN VIVO
                      </div>
                    )}
                  </>
                ) : (
                  <>
                    <img src={capturedImage} alt="Captura" className="w-full h-full object-cover" />
                    {/* Badge de confirmaci√≥n */}
                    <div className="absolute top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-full text-sm font-bold flex items-center gap-2">
                      <span>‚úì</span>
                      Foto Lista
                    </div>
                  </>
                )}
              </div>
              
              {/* BOTONES DE ACCI√ìN */}
              <div className="grid grid-cols-2 gap-4">
                {!cameraActive && !capturedImage && (
                  <>
                    <button
                      onClick={handleStartCamera}
                      className="bg-purple-600 text-white py-4 rounded-xl font-bold hover:bg-purple-700 transition-all flex items-center justify-center gap-2"
                    >
                      <Camera className="w-5 h-5" />
                      Usar C√°mara
                    </button>
                    <button
                      onClick={handleUploadClick}
                      className="bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition-all flex items-center justify-center gap-2"
                    >
                      üìÅ Subir Foto
                    </button>
                  </>
                )}
                
                {cameraActive && (
                  <>
                    <button
                      onClick={handleCapturePhoto}
                      className="bg-green-600 text-white py-4 rounded-xl font-bold hover:bg-green-700 transition-all flex items-center justify-center gap-2"
                    >
                      üì∏ Capturar
                    </button>
                    <button
                      onClick={handleUploadClick}
                      className="bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition-all flex items-center justify-center gap-2"
                    >
                      üìÅ Subir en su lugar
                    </button>
                  </>
                )}
                
                {capturedImage && (
                  <>
                    <button
                      onClick={handleRetakePhoto}
                      className="bg-gray-500 text-white py-4 rounded-xl font-bold hover:bg-gray-600 transition-all flex items-center justify-center gap-2"
                    >
                      <Camera className="w-5 h-5" />
                      Tomar otra
                    </button>
                    <button
                      onClick={handleUploadClick}
                      className="bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition-all flex items-center justify-center gap-2"
                    >
                      üìÅ Subir otra
                    </button>
                  </>
                )}
              </div>
              
              {/* TIPS DE CALIDAD */}
              <div className="mt-4 bg-blue-50 border-l-4 border-blue-500 p-4 rounded-lg">
                <h4 className="font-bold text-blue-900 text-sm mb-2">üí° Tips para foto de calidad:</h4>
                <ul className="text-blue-800 text-xs space-y-1">
                  <li>‚úì Iluminaci√≥n frontal (evita sombras duras)</li>
                  <li>‚úì Rostro completo visible y centrado</li>
                  <li>‚úì Expresi√≥n neutra, mirada al frente</li>
                  <li>‚úì Sin lentes, cabello fuera del rostro</li>
                  <li>‚úì Fondo neutro preferible</li>
                </ul>
              </div>
            </div>
            
            {/* MENSAJE DE ADVERTENCIA SI FALTA ALGO */}
            {(!patientId || !patientName || !capturedImage) && !processing && (
              <div className="mb-4 bg-yellow-50 border-2 border-yellow-400 rounded-xl p-4">
                <p className="text-yellow-900 font-semibold text-sm">
                  ‚ö†Ô∏è Para iniciar el diagn√≥stico necesitas:
                </p>
                <ul className="text-yellow-800 text-sm mt-2 space-y-1">
                  {!patientId && <li>‚Ä¢ ID del paciente</li>}
                  {!patientName && <li>‚Ä¢ Nombre del paciente</li>}
                  {!capturedImage && <li>‚Ä¢ Foto del paciente</li>}
                </ul>
              </div>
            )}
            
            <button
              onClick={handleCompleteDiagnosis}
              disabled={processing || !patientId || !patientName || !capturedImage}
              className="w-full bg-gradient-to-r from-purple-600 via-indigo-600 to-purple-600 text-white py-5 rounded-xl text-xl font-bold hover:shadow-2xl hover:scale-[1.02] transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
              title={!patientId || !patientName || !capturedImage ? 'Completa todos los campos requeridos' : 'Iniciar diagn√≥stico'}
            >
              {processing ? '‚è≥ Procesando...' : 'üöÄ INICIAR DIAGN√ìSTICO INTEGRAL'}
            </button>
            
            {processing && (
              <div className="mt-8 space-y-3">
                <div className="flex items-center justify-between text-sm">
                  <span>üì∏ An√°lisis Maya-Vision...</span>
                  <div className="animate-spin">‚öôÔ∏è</div>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span>üí™ Lectura InBody H30...</span>
                  <div className="animate-spin">‚öôÔ∏è</div>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span>‚öõÔ∏è Escaneo Quantum...</span>
                  <div className="animate-spin">‚öôÔ∏è</div>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span>üß† Cerebro Maya analizando...</span>
                  <div className="animate-spin">‚öôÔ∏è</div>
                </div>
                <div className="flex items-center justify-between text-sm">
                  <span>üíä Generando prescripci√≥n...</span>
                  <div className="animate-spin">‚öôÔ∏è</div>
                </div>
              </div>
            )}
          </div>
        </div>
        
        {/* RESULTS SECTION */}
        {result && (
          <div className="space-y-8">
            {/* AN√ÅLISIS VISUAL TIPO CANFIELD VISIA/VECTRA */}
            {result.visuals && (
              <div className="bg-white rounded-3xl shadow-2xl p-8">
                <h2 className="text-3xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                  <Camera className="w-8 h-8 text-purple-600" />
                  An√°lisis Visual Maya-Vision Pro
                  <span className="text-sm font-normal text-gray-500 ml-auto">
                    Tecnolog√≠a tipo Canfield VISIA/VECTRA
                  </span>
                </h2>
                
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* FOTO ORIGINAL */}
                  <div className="space-y-2">
                    <h3 className="font-bold text-gray-700 text-sm uppercase">
                      üì∑ Foto Original
                    </h3>
                    <div className="rounded-xl overflow-hidden shadow-lg border-2 border-gray-200">
                      <img src={result.visuals.originalPhoto} alt="Original" className="w-full" />
                    </div>
                  </div>
                  
                  {/* FOTO CON AN√ÅLISIS */}
                  <div className="space-y-2">
                    <h3 className="font-bold text-purple-700 text-sm uppercase">
                      üî¨ An√°lisis + Overlays
                    </h3>
                    <div className="rounded-xl overflow-hidden shadow-lg border-4 border-purple-500">
                      <img src={result.visuals.analyzedPhoto} alt="Con an√°lisis" className="w-full" />
                    </div>
                    <p className="text-xs text-gray-600 italic">
                      Zonas de laxitud, calidad de piel y scores visuales
                    </p>
                  </div>
                  
                  {/* SIMULACI√ìN POST-PROCEDIMIENTO */}
                  <div className="space-y-2">
                    <h3 className="font-bold text-green-700 text-sm uppercase">
                      ‚ú® Simulaci√≥n "Despu√©s" (Post-Procedimiento)
                    </h3>
                    <div className="rounded-xl overflow-hidden shadow-lg border-4 border-green-500">
                      <img src={result.visuals.afterSimulation} alt="Despu√©s" className="w-full" />
                    </div>
                    <p className="text-xs text-gray-600 italic">
                      Proyecci√≥n visual con mejoras en piel, laxitud y tono
                    </p>
                  </div>
                  
                  {/* MAPA DE CALOR DE PIEL */}
                  <div className="space-y-2">
                    <h3 className="font-bold text-orange-700 text-sm uppercase">
                      üé® Mapa de Calidad de Piel (tipo VISIA)
                    </h3>
                    <div className="rounded-xl overflow-hidden shadow-lg border-4 border-orange-500">
                      <img src={result.visuals.heatmapSkin} alt="Heatmap" className="w-full" />
                    </div>
                    <p className="text-xs text-gray-600 italic">
                      Rojo=problemas, Naranja=a mejorar, Verde=excelente
                    </p>
                  </div>
                  
                  {/* MAPA DE ARRUGAS */}
                  <div className="space-y-2">
                    <h3 className="font-bold text-red-700 text-sm uppercase">
                      üìè Mapa de Arrugas Detectadas
                    </h3>
                    <div className="rounded-xl overflow-hidden shadow-lg border-4 border-red-500">
                      <img src={result.visuals.wrinkleMap} alt="Arrugas" className="w-full" />
                    </div>
                    <p className="text-xs text-gray-600 italic">
                      L√≠neas de expresi√≥n y zonas de laxitud marcadas
                    </p>
                  </div>
                  
                  {/* ZONAS DE LAXITUD */}
                  <div className="space-y-2">
                    <h3 className="font-bold text-yellow-700 text-sm uppercase">
                      ‚ö†Ô∏è Zonas de Laxitud Facial
                    </h3>
                    <div className="rounded-xl overflow-hidden shadow-lg border-4 border-yellow-500">
                      <img src={result.visuals.laxityZones} alt="Laxitud" className="w-full" />
                    </div>
                    <p className="text-xs text-gray-600 italic">
                      Jowls, cuello y √°reas que requieren atenci√≥n quir√∫rgica
                    </p>
                  </div>
                </div>
                
                {/* COMPARACI√ìN LADO A LADO */}
                <div className="mt-8 bg-gradient-to-r from-purple-50 to-green-50 rounded-2xl p-6">
                  <h3 className="font-bold text-gray-900 text-xl mb-4 text-center">
                    üìä Comparaci√≥n: Antes vs Despu√©s (Proyecci√≥n)
                  </h3>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <p className="text-center font-bold text-gray-700 mb-2">ANTES</p>
                      <img src={result.visuals.originalPhoto} alt="Antes" className="rounded-xl shadow-lg w-full" />
                    </div>
                    <div>
                      <p className="text-center font-bold text-green-700 mb-2">DESPU√âS (Proyecci√≥n)</p>
                      <img src={result.visuals.afterSimulation} alt="Despu√©s" className="rounded-xl shadow-lg w-full" />
                    </div>
                  </div>
                  <div className="mt-4 text-center">
                    <p className="text-sm text-gray-600">
                      ‚ö†Ô∏è Esta es una simulaci√≥n visual basada en algoritmos. Los resultados reales pueden variar.
                    </p>
                  </div>
                </div>
              </div>
            )}
            
            {/* FOTO SIMPLE (SI NO HAY VISUALS) */}
            {!result.visuals && (
              <div className="bg-white rounded-3xl shadow-2xl p-8">
                <h2 className="text-3xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                  <Camera className="w-8 h-8 text-purple-600" />
                  Foto de An√°lisis
                </h2>
                <div className="rounded-2xl overflow-hidden shadow-lg max-w-2xl mx-auto">
                  <img src={result.photoData} alt="An√°lisis facial" className="w-full" />
                </div>
              </div>
            )}
            
            {/* BIOLOGICAL AGE CARD */}
            <div className="bg-gradient-to-br from-purple-600 to-indigo-600 text-white rounded-3xl shadow-2xl p-10">
              <h2 className="text-3xl font-bold mb-8 flex items-center gap-3">
                <Heart className="w-8 h-8" />
                Tu Edad Biol√≥gica
              </h2>
              
              <div className="grid grid-cols-2 gap-8 mb-8">
                <div className="bg-white/10 backdrop-blur-xl rounded-2xl p-8 text-center">
                  <div className="text-sm font-semibold uppercase tracking-wider opacity-80 mb-3">
                    Edad Cronol√≥gica
                  </div>
                  <div className="text-7xl font-black">
                    {result.chronologicalAge}
                  </div>
                  <div className="text-lg mt-2 opacity-80">a√±os</div>
                </div>
                
                <div className="bg-white/10 backdrop-blur-xl rounded-2xl p-8 text-center">
                  <div className="text-sm font-semibold uppercase tracking-wider opacity-80 mb-3">
                    Edad Biol√≥gica
                  </div>
                  <div className="text-7xl font-black text-green-300">
                    {result.biologicalAge}
                  </div>
                  <div className="text-lg mt-2 opacity-80">a√±os</div>
                </div>
              </div>
              
              <div className="bg-green-500/20 backdrop-blur-xl rounded-2xl p-6 text-center border-2 border-green-300/30">
                <div className="text-2xl font-bold">
                  ‚úÖ ERES {result.chronologicalAge - result.biologicalAge} A√ëOS M√ÅS JOVEN
                </div>
                <div className="text-sm mt-2 opacity-90">
                  que tu edad cronol√≥gica seg√∫n biomarcadores
                </div>
              </div>
            </div>
            
            {/* METRICS GRID */}
            <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">
                  Simetr√≠a (Golden Ratio)
                </div>
                <div className="text-5xl font-black text-purple-600 mb-4">
                  {result.symmetryScore}
                </div>
                <div className="w-full bg-gray-200 rounded-full h-3">
                  <div
                    className="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-1000"
                    style={{ width: `${result.symmetryScore}%` }}
                  />
                </div>
              </div>
              
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">
                  Calidad de Piel (Obagi)
                </div>
                <div className="text-5xl font-black text-indigo-600 mb-4">
                  {result.skinQuality}
                </div>
                <div className="w-full bg-gray-200 rounded-full h-3">
                  <div
                    className="bg-gradient-to-r from-indigo-500 to-blue-500 h-3 rounded-full transition-all duration-1000"
                    style={{ width: `${result.skinQuality}%` }}
                  />
                </div>
              </div>
              
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">
                  Laxitud Facial (Connell)
                </div>
                <div className="text-5xl font-black text-amber-600 mb-4">
                  {result.laxityScore}
                </div>
                <div className="w-full bg-gray-200 rounded-full h-3">
                  <div
                    className="bg-gradient-to-r from-amber-500 to-orange-500 h-3 rounded-full transition-all duration-1000"
                    style={{ width: `${result.laxityScore}%` }}
                  />
                </div>
              </div>
              
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">
                  Phase Angle (Celular)
                </div>
                <div className="text-5xl font-black text-green-600 mb-4">
                  {result.phaseAngle.toFixed(1)}
                </div>
                <div className="w-full bg-gray-200 rounded-full h-3">
                  <div
                    className="bg-gradient-to-r from-green-500 to-emerald-500 h-3 rounded-full transition-all duration-1000"
                    style={{ width: `${(result.phaseAngle / 8) * 100}%` }}
                  />
                </div>
              </div>
              
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">
                  Masa Muscular (InBody)
                </div>
                <div className="text-5xl font-black text-blue-600 mb-4">
                  {result.muscleMass.toFixed(1)}
                </div>
                <div className="text-sm text-gray-600 mt-2">kg</div>
              </div>
              
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">
                  S√≠ntesis Col√°geno
                </div>
                <div className="text-5xl font-black text-pink-600 mb-4">
                  {result.collagenSynthesis}
                </div>
                <div className="w-full bg-gray-200 rounded-full h-3">
                  <div
                    className="bg-gradient-to-r from-pink-500 to-rose-500 h-3 rounded-full transition-all duration-1000"
                    style={{ width: `${result.collagenSynthesis}%` }}
                  />
                </div>
              </div>
              
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">
                  Inflamaci√≥n NFŒ∫B
                </div>
                <div className="text-5xl font-black text-red-600 mb-4">
                  {result.inflammation}
                </div>
                <div className="w-full bg-gray-200 rounded-full h-3">
                  <div
                    className="bg-gradient-to-r from-red-500 to-orange-500 h-3 rounded-full transition-all duration-1000"
                    style={{ width: `${result.inflammation}%` }}
                  />
                </div>
              </div>
              
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">
                  Grasa Visceral
                </div>
                <div className="text-5xl font-black text-orange-600 mb-4">
                  {result.visceralFat}
                </div>
                <div className="text-sm text-gray-600 mt-2">nivel 1-20</div>
              </div>
            </div>
            
            {/* PRESCRIPTION CARD */}
            <div className="bg-gradient-to-br from-amber-50 to-orange-50 rounded-3xl shadow-2xl p-10 border-2 border-amber-200">
              <h2 className="text-3xl font-bold text-gray-900 mb-6 flex items-center gap-3">
                <TrendingUp className="w-8 h-8 text-amber-600" />
                Tu Protocolo Epigen√©tico
              </h2>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                <div className="bg-white rounded-2xl p-6">
                  <div className="text-sm font-semibold text-gray-500 mb-2">
                    Productos Prescritos
                  </div>
                  <div className="text-4xl font-black text-amber-600">
                    {result.prescriptionItems}
                  </div>
                  <div className="text-sm text-gray-600 mt-2">
                    Nutrac√©uticos personalizados
                  </div>
                </div>
                
                <div className="bg-white rounded-2xl p-6">
                  <div className="text-sm font-semibold text-gray-500 mb-2">
                    Inversi√≥n Mensual
                  </div>
                  <div className="text-4xl font-black text-green-600">
                    ${(result.monthlyCost / 1000).toFixed(0)}K
                  </div>
                  <div className="text-sm text-gray-600 mt-2">
                    COP / mes
                  </div>
                </div>
              </div>
              
              <div className="bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-2xl p-6 text-center">
                <div className="text-xl font-bold mb-2">
                  ‚úÖ Pedido listo para Interdrogas
                </div>
                <div className="text-sm opacity-90">
                  Env√≠o autom√°tico a WhatsApp 6024873000
                </div>
                <button className="mt-4 bg-white text-green-600 px-8 py-3 rounded-xl font-bold hover:bg-gray-100 transition-all">
                  üì± Enviar Pedido Ahora
                </button>
              </div>
            </div>
            
            {/* SIMULACI√ìN DE CIRUG√çAS */}
            <div className="bg-white rounded-3xl shadow-2xl p-10">
              <h2 className="text-3xl font-bold text-gray-900 mb-6">
                üîÆ Simulaciones Quir√∫rgicas
              </h2>
              <p className="text-gray-600 mb-8">
                Predicciones basadas en ratios cient√≠ficos (Le Fort I, Sagital) + datos reales de col√°geno y grasa
              </p>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                {/* ANTES */}
                <div className="border-4 border-gray-200 rounded-2xl overflow-hidden">
                  <div className="bg-gray-800 text-white px-4 py-3 text-center font-bold">
                    ANTES
                  </div>
                  <div className="aspect-[3/4] bg-gray-100 flex items-center justify-center">
                    <img src={result.photoData} alt="Antes" className="w-full h-full object-cover" />
                  </div>
                  <div className="bg-gray-50 px-4 py-3">
                    <div className="text-sm text-gray-700 space-y-1">
                      <div>‚Ä¢ Laxitud: {result.laxityScore}/100</div>
                      <div>‚Ä¢ Simetr√≠a: {result.symmetryScore}/100</div>
                      <div>‚Ä¢ Calidad piel: {result.skinQuality}/100</div>
                    </div>
                  </div>
                </div>
                
                {/* DESPU√âS (SIMULADO) */}
                <div className="border-4 border-green-500 rounded-2xl overflow-hidden shadow-xl">
                  <div className="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-4 py-3 text-center font-bold">
                    DESPU√âS (Proyecci√≥n con Deep Plane + Obagi Protocol)
                  </div>
                  <div className="aspect-[3/4] bg-gradient-to-br from-green-50 to-emerald-50 flex items-center justify-center relative">
                    <img src={result.photoData} alt="Despu√©s" className="w-full h-full object-cover opacity-90 saturate-110 contrast-110" style={{ filter: 'brightness(1.1)' }} />
                    <div className="absolute inset-0 bg-green-500/5"></div>
                    <div className="absolute top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg font-bold text-sm shadow-lg">
                      +{Math.round((95 - result.symmetryScore) * 0.7)}% Mejora
                    </div>
                  </div>
                  <div className="bg-green-50 px-4 py-3">
                    <div className="text-sm text-gray-700 space-y-1 font-semibold">
                      <div className="text-green-700">‚úì Laxitud reducida 70%</div>
                      <div className="text-green-700">‚úì Simetr√≠a optimizada (Golden Ratio 1.618)</div>
                      <div className="text-green-700">‚úì Calidad piel +25 puntos (Obagi Protocol)</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div className="mt-8 bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
                <h4 className="font-bold text-blue-900 mb-2">üìê Ratios Cient√≠ficos Aplicados:</h4>
                <ul className="text-blue-800 text-sm space-y-1">
                  <li>‚Ä¢ <strong>Le Fort I:</strong> Ajuste de tercio medio facial seg√∫n estructura √≥sea</li>
                  <li>‚Ä¢ <strong>Ratio Sagital:</strong> Correcci√≥n de proyecci√≥n nasal y ment√≥n</li>
                  <li>‚Ä¢ <strong>Deep Plane SMAS:</strong> Reposicionamiento vectorial de tejidos profundos</li>
                  <li>‚Ä¢ <strong>Col√°geno: {result.collagenSynthesis}/100</strong> - Capacidad de cicatrizaci√≥n √≥ptima</li>
                  <li>‚Ä¢ <strong>Grasa Visceral: {result.visceralFat}/20</strong> - Inflamaci√≥n bajo control</li>
                </ul>
              </div>
            </div>
            
            {/* üÜï V3.0: RECOMENDACIONES PERSONALIZADAS CON MOTOR INTEGRADO */}
            <div className="bg-white rounded-3xl shadow-2xl p-10">
              <h2 className="text-3xl font-bold text-gray-900 mb-8 flex items-center gap-3">
                üß† Plan de Tratamiento Personalizado
                <span className="text-sm font-normal text-purple-600 bg-purple-100 px-3 py-1 rounded-full">
                  Park + Connell + Obagi + Yu
                </span>
              </h2>
              
              {/* DATOS DEL PACIENTE */}
              <div className="grid grid-cols-4 gap-4 mb-8 bg-gradient-to-r from-purple-50 to-blue-50 rounded-2xl p-6">
                <div>
                  <div className="text-sm text-gray-600">Edad</div>
                  <div className="text-xl font-bold">{patientAge} a√±os</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600">G√©nero</div>
                  <div className="text-xl font-bold">{patientGender === 'F' ? 'üë© Femenino' : 'üë® Masculino'}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600">Etnia</div>
                  <div className="text-xl font-bold capitalize">{patientEthnicity}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600">Tipo</div>
                  <div className="text-xl font-bold capitalize">{analysisType.replace('_', ' ')}</div>
                </div>
              </div>
              
              {/* RESUMEN EJECUTIVO */}
              {result.treatmentPlan && (
                <div className="mb-8 bg-gradient-to-r from-amber-50 to-orange-50 border-2 border-amber-200 rounded-2xl p-6">
                  <h3 className="text-xl font-bold text-amber-900 mb-3 flex items-center gap-2">
                    üéØ Objetivo del Tratamiento
                  </h3>
                  <p className="text-gray-800 leading-relaxed">
                    {result.treatmentPlan.summary || `Plan integral personalizado para ${patientGender === 'F' ? 'mujer' : 'hombre'} de ${patientAge} a√±os, etnia ${patientEthnicity}.`}
                  </p>
                </div>
              )}
              
              {/* üÜï V3.0: RECOMENDACIONES DIN√ÅMICAS DEL MOTOR */}
              
              {/* 1Ô∏è‚É£ PROCEDIMIENTOS QUIR√öRGICOS (Park + Connell) */}
              {result.treatmentPlan?.surgical && result.treatmentPlan.surgical.length > 0 && (
                <div className="mb-8">
                  <h3 className="text-2xl font-bold text-red-600 mb-4 flex items-center gap-2">
                    ‚úÇÔ∏è Procedimientos Quir√∫rgicos Recomendados
                  </h3>
                  <div className="bg-red-50 rounded-2xl p-6 space-y-4">
                    {result.treatmentPlan.surgical.map((proc: any, idx: number) => (
                      <div key={idx} className={`flex justify-between items-start ${idx < result.treatmentPlan.surgical.length - 1 ? 'border-b border-red-200 pb-4' : ''}`}>
                        <div className="flex-1">
                          <div className="font-bold text-gray-900">{proc.procedure}</div>
                          <div className="text-sm text-gray-600 mt-1">{proc.description}</div>
                          <div className="text-xs text-red-700 mt-2 bg-red-100 inline-block px-3 py-1 rounded-full">
                            üìö {proc.source}
                          </div>
                          <div className="text-sm text-red-600 font-semibold mt-2">
                            üí° {proc.rationale}
                          </div>
                        </div>
                        <div className="text-right ml-4">
                          <div className="text-2xl font-black text-red-600">${(proc.cost / 1000000).toFixed(1)}M</div>
                          <div className="text-sm text-gray-500">{proc.recovery}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* 2Ô∏è‚É£ PROCEDIMIENTOS COSM√âTICOS NO QUIR√öRGICOS */}
              {result.treatmentPlan?.nonsurgical && result.treatmentPlan.nonsurgical.length > 0 && (
                <div className="mb-8">
                  <h3 className="text-2xl font-bold text-blue-600 mb-4 flex items-center gap-2">
                    üíâ Procedimientos Cosm√©ticos (No Quir√∫rgicos)
                  </h3>
                  <div className="bg-blue-50 rounded-2xl p-6 space-y-4">
                    {result.treatmentPlan.nonsurgical.map((proc: any, idx: number) => (
                      <div key={idx} className={`flex justify-between items-start ${idx < result.treatmentPlan.nonsurgical.length - 1 ? 'border-b border-blue-200 pb-4' : ''}`}>
                        <div className="flex-1">
                          <div className="font-bold text-gray-900">{proc.procedure}</div>
                          <div className="text-sm text-gray-600 mt-1">{proc.description}</div>
                          <div className="text-xs text-blue-700 mt-2 bg-blue-100 inline-block px-3 py-1 rounded-full">
                            ‚è±Ô∏è Duraci√≥n: {proc.duration}
                          </div>
                          <div className="text-sm text-blue-600 font-semibold mt-2">
                            üí° {proc.rationale}
                          </div>
                        </div>
                        <div className="text-right ml-4">
                          <div className="text-2xl font-black text-blue-600">${(proc.cost / 1000).toFixed(0)}K</div>
                          <div className="text-sm text-gray-500">{proc.frequency}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* 3Ô∏è‚É£ PROTOCOLO DERMATOL√ìGICO (Obagi Moderno) */}
              {result.treatmentPlan?.skincare && result.treatmentPlan.skincare.length > 0 && (
                <div className="mb-8">
                  <h3 className="text-2xl font-bold text-purple-600 mb-4 flex items-center gap-2">
                    üß¥ Protocolo Dermatol√≥gico (SIN Hidroquinona)
                  </h3>
                  <div className="bg-purple-50 rounded-2xl p-6 space-y-4">
                    {result.treatmentPlan.skincare.map((prod: any, idx: number) => (
                      <div key={idx} className={`flex justify-between items-start ${idx < result.treatmentPlan.skincare.length - 1 ? 'border-b border-purple-200 pb-4' : ''}`}>
                        <div className="flex-1">
                          <div className="font-bold text-gray-900">{prod.product}</div>
                          <div className="text-sm text-gray-600 mt-1">{prod.usage}</div>
                          <div className="text-xs text-purple-700 mt-2 bg-purple-100 inline-block px-3 py-1 rounded-full">
                            üî¨ Ingrediente activo: {prod.active_ingredient}
                          </div>
                          <div className="text-sm text-purple-600 font-semibold mt-2">
                            üí° {prod.rationale}
                          </div>
                        </div>
                        <div className="text-right ml-4">
                          <div className="text-2xl font-black text-purple-600">${(prod.cost / 1000).toFixed(0)}K</div>
                          <div className="text-sm text-gray-500">{prod.size}</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* 4Ô∏è‚É£ NUTRACEUTICOS (Byung Pal Yu) */}
              {result.treatmentPlan?.supplements && result.treatmentPlan.supplements.length > 0 && (
                <div className="mb-8">
                  <h3 className="text-2xl font-bold text-green-600 mb-4 flex items-center gap-2">
                    üíä Nutraceuticos Personalizados (Byung Pal Yu)
                  </h3>
                  <div className="bg-green-50 rounded-2xl p-6 space-y-4">
                    {result.treatmentPlan.supplements.map((supp: any, idx: number) => (
                      <div key={idx} className={`flex justify-between items-start ${idx < result.treatmentPlan.supplements.length - 1 ? 'border-b border-green-200 pb-4' : ''}`}>
                        <div className="flex-1">
                          <div className="font-bold text-gray-900">{supp.supplement}</div>
                          <div className="text-sm text-gray-600 mt-1">{supp.dosage}</div>
                          <div className="text-xs text-green-700 mt-2 bg-green-100 inline-block px-3 py-1 rounded-full">
                            üß¨ Mecanismo: {supp.mechanism}
                          </div>
                          <div className="text-sm text-green-600 font-semibold mt-2">
                            üí° {supp.rationale}
                          </div>
                        </div>
                        <div className="text-right ml-4">
                          <div className="text-2xl font-black text-green-600">${(supp.cost / 1000).toFixed(0)}K</div>
                          <div className="text-sm text-gray-500">Mensual</div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* FALLBACK: Mensaje si no hay tratmentPlan */}
              {!result.treatmentPlan && (
                <div className="mb-8 bg-gray-50 rounded-2xl p-8 text-center">
                  <div className="text-4xl mb-4">‚ö†Ô∏è</div>
                  <div className="text-lg font-semibold text-gray-700">
                    Plan de tratamiento en generaci√≥n...
                  </div>
                  <div className="text-sm text-gray-500 mt-2">
                    Si este mensaje persiste, verifica la consola del navegador (F12)
                  </div>
                </div>
              )}
              
              {/* üÜï V3.0: CALCULADORA ROI CIRUG√çA VS NO QUIR√öRGICO */}
              {result.treatmentPlan && patientAge && (
                <div className="mb-8">
                  <SurgeryCalculator 
                    patientAge={patientAge}
                    boneDeficiency={result.treatmentPlan.bone_assessment?.deficiency || 0}
                    currentSymmetry={result.symmetryScore}
                  />
                </div>
              )}
              
              {/* üÜï V3.0: TOTAL CALCULADO DIN√ÅMICAMENTE */}
              {result.treatmentPlan && (() => {
                const supplementsCost = (result.treatmentPlan.supplements || []).reduce((sum: number, s: any) => sum + s.cost, 0)
                const skincareCost = (result.treatmentPlan.skincare || []).reduce((sum: number, s: any) => sum + s.cost, 0)
                const totalMonthly = supplementsCost + skincareCost
                
                return (
                  <div className="mt-8 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-2xl p-6 text-center">
                    <div className="text-sm font-semibold uppercase tracking-wider mb-2">Total Inversi√≥n Mensual Personalizada</div>
                    <div className="text-5xl font-black mb-2">${(totalMonthly / 1000).toFixed(0)}K COP</div>
                    <div className="text-sm opacity-90">(Suplementos + Dermatol√≥gicos - Excluye cirug√≠as y procedimientos)</div>
                  </div>
                )
              })()}
            </div>
            
            {/* PASSPORT CARD */}
            <div className="bg-gradient-to-br from-purple-900 to-indigo-900 text-white rounded-3xl shadow-2xl p-10">
              <h2 className="text-3xl font-bold mb-6 flex items-center gap-3">
                <Shield className="w-8 h-8" />
                Pasaporte de Inmortalidad
              </h2>
              
              <p className="text-lg opacity-90 mb-8">
                Tu plan completo de reprogramaci√≥n epigen√©tica est√° listo.
                Incluye proyecciones quir√∫rgicas, protocolos nutrac√©uticos y plan de seguimiento.
              </p>
              
              <div className="flex gap-4">
                <button 
                  onClick={handleDownloadPDF}
                  className="flex-1 bg-white text-purple-900 py-4 rounded-xl font-bold hover:bg-gray-100 transition-all shadow-lg hover:shadow-xl"
                >
                  üìÑ Descargar PDF
                </button>
                <button 
                  onClick={() => setShowEmailModal(true)}
                  disabled={!result}
                  className="flex-1 bg-purple-700 hover:bg-purple-600 disabled:bg-gray-400 disabled:cursor-not-allowed py-4 rounded-xl font-bold transition-all"
                >
                  üìß Enviar por Email
                </button>
                <button 
                  onClick={() => setShowShareModal(true)}
                  disabled={!result}
                  className="flex-1 bg-purple-700 hover:bg-purple-600 disabled:bg-gray-400 disabled:cursor-not-allowed py-4 rounded-xl font-bold transition-all"
                >
                  üì± Compartir
                </button>
              </div>
            </div>
            
            {/* ACTION BUTTONS */}
            <div className="flex gap-4">
              <button
                onClick={() => setResult(null)}
                className="flex-1 bg-gray-500 text-white py-4 rounded-xl font-bold hover:bg-gray-600 transition-all"
              >
                ‚Üê Nuevo Diagn√≥stico
              </button>
              <button className="flex-1 bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition-all">
                üíæ Guardar en Historial
              </button>
            </div>
          </div>
        )}
        
        {/* INFO FOOTER */}
        {!result && !processing && (
          <div className="max-w-4xl mx-auto">
            <div className="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
              <h3 className="font-bold text-blue-900 mb-2">
                üî¨ Sistema Integrado de 7 Niveles
              </h3>
              <ul className="text-blue-800 space-y-1 text-sm">
                <li>‚úÖ <strong>Nivel 1:</strong> Maya-Vision (An√°lisis fotogr√°fico Connell + Obagi)</li>
                <li>‚úÖ <strong>Nivel 2:</strong> InBody H30 (Composici√≥n corporal real)</li>
                <li>‚úÖ <strong>Nivel 3:</strong> Quantum Analyzer (53 biomarcadores)</li>
                <li>‚úÖ <strong>Nivel 4:</strong> Cerebro Maya (S√≠ntesis 50+ tratados)</li>
                <li>‚úÖ <strong>Nivel 5:</strong> Vadem√©cum Autom√°tico (Prescripci√≥n personalizada)</li>
                <li>‚úÖ <strong>Nivel 6:</strong> Predicci√≥n Mecanobiol√≥gica (Ratios quir√∫rgicos)</li>
                <li>‚úÖ <strong>Nivel 7:</strong> Pasaporte de Inmortalidad (Plan epigen√©tico completo)</li>
              </ul>
            </div>
          </div>
        )}
      </div>
      
      {/* üÜï V3.1: MODALES */}
      {showShareModal && result && (
        <SocialShareModal
          patientName={patientName}
          patientId={patientId}
          biologicalAge={result.biologicalAge}
          chronologicalAge={result.chronologicalAge}
          symmetryScore={result.symmetryScore}
          onClose={() => setShowShareModal(false)}
        />
      )}
      
      {showEmailModal && result && (
        <EmailSendModal
          patientName={patientName}
          patientId={patientId}
          biologicalAge={result.biologicalAge}
          chronologicalAge={result.chronologicalAge}
          symmetryScore={result.symmetryScore}
          skinQuality={result.skinQuality}
          laxityScore={result.laxityScore}
          onClose={() => setShowEmailModal(false)}
        />
      )}
      
      {/* üî• V3.2: MAYA-SCAN 3D */}
      {show3DScan && (
        <MayaScan3DSimple
          onComplete={(mesh, captures) => {
            setMesh3D(mesh)
            setShow3DScan(false)
            alert(`‚úÖ Escaneo 3D completado! ${captures.length} fotos capturadas.\n\nAhora puedes iniciar el diagn√≥stico integral.`)
          }}
          onCancel={() => setShow3DScan(false)}
        />
      )}
    </div>
  )
}
